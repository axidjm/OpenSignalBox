# OpenSignalBox
A framework for a signal box simulator, initially based on that used by St Albans South

I thought I would share my plans for a free, open simulator for both physical and virtual signal boxes. I’m calling the idea OpenSignalBox (osb).
## The main desirables are:
1. Free and open source, so charitable projects can focus fundraising on unavoidable costs like construction and site costs. Also, I like to keep my hobbies separate from financial interests…
2. Simple to set up a new instance. It should not require specialist knowledge that only a handful of people possess to apply the system to a new site/attic/bedroom.
3. Straightforward to adapt or extend to particular instances.
4. Hardware, when required, should be a format which commercial off-the-shelf products can be sourced, from multiple manufacturers, to reduce the chance of obsolescence and reverse engineering proprietary designs.
5. Portable interface. We now live in the 2020s, the UI should be web-based and usable on the pocket computers we all carry around. My thought for inside signal boxes is to have a tablet that can be brought into the operating floor when useful or hidden in a cupboard/train register desk. A maintenance view should allow easy manipulation of outputs and checking inputs whilst up ladders, under equipment etc.
6. Easy to edit and add new “consumables” – routes, timetables, styled UI glyphs.
## Nice-to-haves:
7. Decent map view showing the real track layout and smooth train movements. This makes it easier for people to create their layouts by tracing over plans/maps, as well as giving accurate train movements over real track lengths. This takes inspiration from the Polish ISDR panel simulator which is very impressive in this respect.
8. Network access for clients with granular access control. By this I mean the ability to connect whole simulators together over the internet, but also allow adjacent boxes to be controlled by remote clients on the same internet-attached sim. This would extend to phone systems where possible, using VOIP/SIP interfaces to box telephones.
9. Visual electrical locking editor. Nothing complicated, but lets you edit interlocking for adjacent boxes or anything that isn’t implemented physically.
10. Automated SPT/adjacent box calls for “single-player” operation. Cowley bridge sim has this feature.
11. Scoring system for challenging timetables.
12. Interesting mechanical era failures like train splitting/running away.
## Policy:
1. Free and open source. Software will be hosted on Github sharing platform and example hardware designs will be published but not sold as part of the project. Point 4 covers this in more details.
2. Simple to set up a new instance. All information needed to set up is published online. A forum can also be made for a community to provide help. Software has an installer and can check for updates which don’t break configurations.
3. Straightforward to adapt or extend to specialised instances. Combined with Point 1, this has led to the choice of Python for the programming language of the simulator. Ubiquity, ease of use, portability and maturity add to the pros. Should be plenty performant for a signal box simulator.
4. COTS hardware. I want an open standard which is well supported by commercial interfaces and suits relay/bit interfacing well. TCP/IP interfacing would be very beneficial. So, Modbus seems an obvious choice. Massively proven protocol, both RS485 and TCP/IP implementations available, plenty of 8/16/32 channel IO interfaces available to buy online from £50 cheap units to £500 high-end ones. Even supports power over ethernet so could put a remote interface in a signal garden/yard and run a single Cat6 cable to it. For dense IO areas, can run ethernet to a Modbus RS485 adapter (<£50) then chain RS485 to conventional interfaces. As Modbus is fully open and there are many open code implementation for Arduino/ARM/PIC microcontrollers, it is also easy for those inclined to build suitable IO for their projects. The osb project wouldn’t sell hardware but would publish some example designs. That leaves others free to sell hardware should they wish. This all said, however, I intend to make the interface abstract so other network protocols can be used – e.g. MQTT, CANbus. Potentially model rail protocols can be included like Loconet and DCC via adapters, but that’s an extension. I want to avoid USB like the plague as networking kit is so cheap and Swindon Panel was a messy use of USB interfacing. Finally, Modbus should be plenty fast enough for even large mechanical box interfacing. Swindon Panel has many thousands of IO so wouldn’t have been suitable, but this is a different kettle of fish (I know as I was designing the replacements interfaces before I left – over twenty 64-channel CANbus cards using OpenMRN/LCC, although I think they’ve gone in a different direction now I’m gone).
5. Portable interface. I want it to be based around a web interface, not just have an API server bolted on the side. Since we are open it means we don’t need to hide behind compiled binaries which in my opinion is one of the main reasons for keeping things away from web-based architectures. Secondly, I’d like to see the project supported by younger programmers, who are increasingly specialists in web software (Javascript/ECMAscript/Typescript, Python, Go) and not C/C++/Java. Python is a nice middle ground here, so a Python backend and JS frontend make sense to me and I think have the widest developer audience. The most popular and mature Python web framework (useful for consistency, reducing boilerplate and discipline during growth) is Django. The newer versions support asynchronous programming, so it is well suited to long slow streaming connections like those between the simulator and a web client. Another benefit of Python backend over NodeJS or similar native-event-driven language is that the core simulator logic can be pure Python separate from the web mechanics, so other projects can copy the simulation logic for their own use, or easily tweak it without being obscured by web stuff. For the front-end, my first choice is to use Vue, which is a highly regarded framework which makes it easy to connect data to UI components and comes with rich templating features. I have previously written a mock IECC display for Didcot area which took live train describer data from the Network Rail feeds and showed the states of all signals and TD berth movements – this used Vue and was easily readable despite being written within a few days.
6. …
7. Decent map view. My plan for the core simulation mechanic revolves around vectors, specifically SVG vectors. To form the most accurate simulation, the trains should follow the real track plan, which can be digitised as vectors easily over a map or plan. This could be done in a vector editor (e.g., inkscape) or inside the web interface of osb. Either way, the resulting layout vectors could be split and assigned to track section IDs inside the osb interface. A route would then consist of a path assembled from multiple segments (straight lines and beziers) and there are nice algorithms available for calculating total path lengths etc. Successive movement authorities (signals off) extend the path and the sim sees more route to drive along. The nice thing about this is that the clients just get streamed the
positions along the path and the velocities and accelerations (for local interpolation) and can easily generate an impressive map view. Train glyphs can be provided on entry to reduce page loading or show bounding boxes if none are available. There can be a way of sharing train glyphs.
8. Network access for clients with granular access control. By this I mean that there should be a way to limit who can access what via the client interface. Django includes extensible access control features which covers this. Also, a standardised API can be defined which allows connection to other simulators which aren’t osb. This is already possible for Simsig as I have written fake external signalboxes in the past. Also, for mechanical box areas contained inside a Simsig route area the newer Simsig data interface would allow osb to cover those signals and receive TDs etc. Ona separate note, a remote telephone interface can be provided via SIP/VOIP either by a concealed modern phone or potentially an interface into an existing concentrator/omnibus. Ultimate goal would be to modify a concentrator to drive any input from a SIP gateway on a Raspberry Pi or something and then the correct SPT works.
9. Visual electrical locking editor. One of the most challenging things about implementing a signal box simulator is incorporating all the local logic and interlocking required. To make reusable software that doesn’t need specialists to set up, this needs to be made easy to implement. The clearest form in my mind is to do it visually in the same style as the wiring diagrams used for the boxes themselves. This can be compiled down to logical expressions or run in a debug/live edit mode with the relays and wire states highlighted, in a similar vein to the Victoria Line ATO sim recent updates.
# Initial Version
As St Albans South have a working simulator, that could be a good place to start, even though it is written in C rather than say Python.
It handles most of what we need in the short term, but has a few issues that need addressing:
1. The configuration is in 2D arrays of integers, rather than an array of structures with named members.
2. It is all in one file, rather than modules
3. The configuration is all in one custom data file, rather than multiple CSV files that would be more easily managed in Excel
4. There are a few (and I really mean only one or two) bits of code that are specifc to St Albans South. So far, all I have found is the 4 lever home numbers that must be normal before Train Out Of Section can be sent. And the fact that St Albans is on 4-track running lines (rather than 'n' running lines).
5. The hardware interface needs generalising so it can run with a wide range of available or customer hardware
6. It would be highly desirable to add train sounds.

This was proposed by Laurence Stant, started by David Moore, and uses St Albans South code from Rob Little.